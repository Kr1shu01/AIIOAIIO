<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surfing-Kitten</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: white;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #uiPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        #score {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        
        #lives {
            font-size: 24px;
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .heart {
            color: #ff4757;
            font-size: 28px;
        }
        
        #status {
            margin-top: 10px;
            font-size: 18px;
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        
        #eventNotification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ff4757;
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
            z-index: 150;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            text-align: center;
        }
        
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 15, 30, 0.95);
            color: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            z-index: 200;
            display: none;
            border: 2px solid rgba(100, 200, 255, 0.3);
            box-shadow: 0 0 30px rgba(77, 238, 234, 0.6);
            backdrop-filter: blur(15px);
            min-width: 400px;
        }
        
        #gameOver h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #4deeea;
            text-shadow: 0 0 10px rgba(77, 238, 234, 0.8);
        }
        
        #finalScore {
            font-size: 28px;
            color: #7fdbca;
            font-weight: bold;
        }
        
        #restartBtn {
            background: linear-gradient(135deg, #2196F3, #0d47a1);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 20px;
            cursor: pointer;
            margin-top: 25px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        #restartBtn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        
        /* ä¸»èœå•æ ·å¼ */
        #mainMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
            background: transparent;
        }
        
        #gameTitle {
            text-align: center;
            font-size: 4rem;
            color: #4deeea;
            text-shadow: 0 0 30px rgba(77, 238, 234, 0.8);
            font-weight: 800;
            letter-spacing: 3px;
            margin-bottom: 30px;
        }
        
        #gameRulesInline {
            background: rgba(15, 25, 50, 0.8);
            color: #e6f7ff;
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            max-width: 800px;
            border: 1px solid rgba(100, 200, 255, 0.2);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            max-height: 60vh;
        }
        
        #gameRulesInline h3 {
            color: #4deeea;
            margin: 15px 0 10px 0;
            font-size: 1.4rem;
            text-shadow: 0 0 10px rgba(77, 238, 234, 0.5);
        }
        
        #gameRulesInline p {
            margin: 10px 0;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        
        #gameRulesInline ul {
            text-align: left;
            margin: 10px 0 15px 30px;
        }
        
        #gameRulesInline li {
            margin: 8px 0;
            line-height: 1.5;
            font-size: 1.05rem;
        }
        
        .highlight {
            color: #4deeea;
            font-weight: 500;
        }
        
        #startGameText {
            font-size: 2.5rem;
            color: #7fdbca;
            text-shadow: 0 0 20px rgba(127, 219, 202, 0.8);
            margin-top: 30px;
            cursor: pointer;
            background: rgba(15, 25, 50, 0.8);
            padding: 20px 40px;
            border-radius: 30px;
            border: 1px solid rgba(100, 200, 255, 0.2);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        #startGameText:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div id="uiPanel">
            <div id="score">å¾—åˆ†: 0</div>
            <div id="lives">
                ç”Ÿå‘½: 
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
            </div>
            <div id="status">é˜¶æ®µ 1</div>
        </div>

        <div id="eventNotification"></div>

        <!-- ä¸»èœå• -->
        <div id="mainMenu">
            <h1 id="gameTitle">ğŸ˜¸ Surfing-Kitten</h1>
            <div id="gameRulesInline">
                <h3>æ“ä½œ:</h3>
                <p>ä½¿ç”¨ <span class="highlight">WASD é”®</span> æ§åˆ¶å°å–µå†²æµª</p>
                
                <h3>ç›®æ ‡:</h3>
                <p>æ”¶é›†èŠ±å–µï¼Œé¿å¼€å±é™©ï¼Œç”Ÿå­˜è¶Šä¹…å¾—åˆ†è¶Šé«˜å–µï¼</p>
                
                <h3>å…ƒç´ :</h3>
                <ul>
                    <li>ğŸŒ¸ èŠ±èŠ±å–µï¼šå¬è¯´ä¼šå¸¦æ¥å¥½è¿ï¼</li>
                    <li>ğŸ¦„ ç‹¬è§’å–µï¼šä¼ è¯´ä¸­çš„å†°å¤©å¸ï¼Ÿ</li>
                    <li>ğŸ¦ˆ é²¨é±¼å–µï¼šç–¯ç‹‚å°é²¨é±¼ã€‚</li>
                    <li>ğŸ’£ ç‚¸å¼¹å–µï¼šæ™®é€šç‚¸å¼¹ã€‚</li>
                    <li>ğŸª¨ ç¤çŸ³å–µï¼šå°çŸ³å¤´èƒ½ä¸èƒ½ç ¸åˆ°å‘¢ï¼Ÿ</li>
                    <li>ğŸ‘¹ å“¥å¸ƒå–µï¼šæˆç¾¤ç»“é˜Ÿï½</li>
                    <li>ğŸ® ç¯ç¬¼å–µï¼šé€æ¸©æš–ã€‚</li>
                </ul>
            </div>
            <div id="startGameText">ğŸ® ç‚¹å‡»å¼€å§‹å†²æµª</div>
        </div>

        <div id="gameOver">
            <h2>æ¸¸æˆç»“æŸ!</h2>
            <p>æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></p>
            <button id="restartBtn">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <script>
        class SurfingGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resizeCanvas();
                
                // æ¸¸æˆçŠ¶æ€
                this.gameState = 'menu'; // menu, playing, gameOver
                
                // é¢„åŠ è½½emojiå›¾åƒæ•°æ®
                this.loadEmojiImages();
                
                // æ˜¾ç¤ºä¸»èœå•
                this.showMainMenu();
                this.setupMenuListeners();
            }
            
            loadEmojiImages() {
                // ä½¿ç”¨æ›´é«˜è´¨é‡çš„è¡¨æƒ…ç¬¦å·ç»˜åˆ¶
                this.emojis = {
                    shark: 'ğŸ¦ˆ',
                    rock: 'ğŸª¨',
                    bomb: 'ğŸ’£',
                    flower: 'ğŸŒ¸',
                    butterfly: 'ğŸ¦„',
                    board: 'ğŸ˜¹', // æ¢æˆå°çŒ«
                    meteor: 'â˜„ï¸',
                    goblin: 'ğŸ‘º',
                    lantern: 'ğŸ®',
                    meteorShadow: 'ğŸŒ‘'
                };
            }
            
            resizeCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }
            
            setupMenuListeners() {
                document.getElementById('startGameText').addEventListener('click', () => {
                    this.startGame();
                });
                
                document.getElementById('restartBtn').addEventListener('click', () => {
                    this.startGame();
                });
            }
            
            showMainMenu() {
                this.gameState = 'menu';
                document.getElementById('mainMenu').style.display = 'flex';
                document.getElementById('gameOver').style.display = 'none';
                document.getElementById('uiPanel').style.display = 'none';
            }
            
            startGame() {
                this.gameState = 'playing';
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('gameOver').style.display = 'none';
                document.getElementById('uiPanel').style.display = 'block';
                
                // åˆå§‹åŒ–æ¸¸æˆ
                this.restartGame();
            }
            
            restartGame() {
                console.log("Restarting game...");
                
                // é‡ç½®æ‰€æœ‰æ¸¸æˆçŠ¶æ€
                this.score = 0;
                this.lives = 9; // æ”¹ä¸º9æ¡å‘½
                this.gameRunning = true;
                this.backgroundColorIndex = 0;
                this.baseSpeed = 2.5; // åŸºç¡€é€Ÿåº¦
                this.speedLevel = 0; // é€Ÿåº¦ç­‰çº§
                this.scorePhase = 0; // å¾—åˆ†é˜¶æ®µ
                
                // é˜¶æ®µäº‹ä»¶æ§åˆ¶ç³»ç»Ÿ
                this.currentPhase = 0;
                this.phaseEventScores = []; // å­˜å‚¨å½“å‰é˜¶æ®µè§¦å‘äº‹ä»¶çš„åˆ†æ•°ç‚¹
                this.triggeredEvents = new Set(); // è®°å½•å·²è§¦å‘çš„äº‹ä»¶
                
                // åˆå§‹åŒ–é˜¶æ®µäº‹ä»¶è®¡åˆ’
                this.initializePhaseEvents();
                
                // é‡ç½®ç©å®¶å±æ€§ï¼ˆåªæœ‰å†²æµªæ¿/å°çŒ«ï¼‰
                this.player = {
                    x: this.canvas.width / 2,
                    y: this.canvas.height - 100,
                    width: 50,
                    height: 50,
                    invincible: false,
                    invincibleTimer: 0,
                    boosting: false,
                    boostTimer: 0
                };
                
                // æ¸…ç©ºæ‰€æœ‰æ¸¸æˆå¯¹è±¡
                this.obstacles = [];
                this.flowers = [];
                this.butterflies = [];
                this.particles = [];
                this.meteors = [];
                this.goblins = [];
                this.lanterns = [];
                
                // é‡ç½®æ—¶é—´ç›¸å…³å˜é‡
                this.lastObstacleTime = 0;
                this.lastFlowerTime = 0;
                this.lastButterflyTime = 0;
                this.obstacleInterval = 1200;
                this.flowerInterval = 1000;
                this.butterflyInterval = 3500;
                
                // è¡€æœˆäº‹ä»¶ç‰¹æ®ŠçŠ¶æ€
                this.bloodMoonActive = false;
                this.bloodMoonTimer = 0;
                this.bloodMoonStartTime = 0;
                
                // é‡ç½®é”®ç›˜è¾“å…¥
                this.keys = {};
                
                // éšè—æ¸¸æˆç»“æŸç•Œé¢
                document.getElementById('gameOver').style.display = 'none';
                
                // æ›´æ–°UIæ˜¾ç¤º
                this.updateUI();
                
                // å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨æ¸¸æˆï¼Œåˆ™åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
                if (!this.initialized) {
                    this.initialized = true;
                    window.addEventListener('resize', () => this.resizeCanvas());
                    
                    document.addEventListener('keydown', (e) => {
                        this.keys[e.key.toLowerCase()] = true;
                    });
                    
                    document.addEventListener('keyup', (e) => {
                        this.keys[e.key.toLowerCase()] = false;
                    });
                    
                    this.gameLoop();
                }
            }
            
            initializePhaseEvents() {
                // ä¸ºå½“å‰é˜¶æ®µéšæœºé€‰æ‹©ä¸¤ä¸ªè§¦å‘åˆ†æ•°ç‚¹å’Œå¯¹åº”çš„äº‹ä»¶
                this.phaseEventScores = [];
                this.triggeredEvents.clear();
                
                // ç”Ÿæˆè¯¥é˜¶æ®µå†…çš„ä¸¤ä¸ªéšæœºåˆ†æ•°ç‚¹
                const phaseStart = this.currentPhase * 50;
                const phaseEnd = phaseStart + 49;
                
                // ç¡®ä¿åˆ†æ•°ç‚¹ä¸é‡å¤ä¸”åœ¨åˆç†èŒƒå›´å†…
                const score1 = Math.floor(Math.random() * 40) + phaseStart + 5; // 5-45èŒƒå›´å†…
                let score2;
                do {
                    score2 = Math.floor(Math.random() * 40) + phaseStart + 5;
                } while (Math.abs(score2 - score1) < 10); // ç¡®ä¿ä¸¤ä¸ªäº‹ä»¶é—´éš”è‡³å°‘10åˆ†
                
                const eventScores = [score1, score2].sort((a, b) => a - b);
                
                // æ ¹æ®æ–°çš„æ¦‚ç‡åˆ†å¸ƒåˆ†é…äº‹ä»¶
                const events = [];
                events.push(this.getRandomEventType());
                events.push(this.getRandomEventType());
                
                this.phaseEventScores = [
                    { score: eventScores[0], event: events[0] },
                    { score: eventScores[1], event: events[1] }
                ];
                
                console.log("Phase events planned:", this.phaseEventScores);
            }
            
            getRandomEventType() {
                // æ–°çš„æ¦‚ç‡åˆ†å¸ƒ: è¡€æœˆ0.3, é™¨çŸ³0.2, å“¥å¸ƒæ—0.3, ç¯ç¬¼0.2
                const rand = Math.random();
                if (rand < 0.3) return 'bloodmoon';   // 30%
                if (rand < 0.5) return 'meteor';      // 20%
                if (rand < 0.85) return 'goblin';     // 35%
                return 'lantern';                     // 15%
            }
            
            updateSpeed() {
                const newSpeedLevel = Math.floor(this.score / 50);
                if (newSpeedLevel !== this.speedLevel) {
                    this.speedLevel = newSpeedLevel;
                }
                
                // æ£€æŸ¥é˜¶æ®µå˜åŒ–
                const newPhase = Math.floor(this.score / 50);
                if (newPhase !== this.currentPhase) {
                    this.currentPhase = newPhase;
                    this.initializePhaseEvents(); // è¿›å…¥æ–°é˜¶æ®µæ—¶é‡æ–°è§„åˆ’äº‹ä»¶
                    if (this.bloodMoonActive) {
                        this.bloodMoonActive = false;
                        this.bloodMoonTimer = 0;
                    }
                }
            }
            
            checkPhaseEvents() {
                // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾é¢„è®¾çš„äº‹ä»¶è§¦å‘åˆ†æ•°
                for (let i = 0; i < this.phaseEventScores.length; i++) {
                    const eventInfo = this.phaseEventScores[i];
                    if (this.score >= eventInfo.score && !this.triggeredEvents.has(eventInfo.score)) {
                        this.triggeredEvents.add(eventInfo.score);
                        
                        // æ˜¾ç¤ºé¢„å‘Šå¹¶è§¦å‘äº‹ä»¶
                        this.showEventNotification(this.getEventName(eventInfo.event));
                        setTimeout(() => {
                            if (this.gameRunning) {
                                this.activateEvent(eventInfo.event);
                            }
                        }, 3000); // 3ç§’åçœŸæ­£è§¦å‘äº‹ä»¶
                    }
                }
            }
            
            get currentSpeed() {
                if (this.bloodMoonActive) {
                    return this.baseSpeed + this.speedLevel * 2; // å½“å‰é˜¶æ®µé€Ÿåº¦çš„2å€
                }
                return this.baseSpeed + this.speedLevel * 0.5; // æ¯50åˆ†å¢åŠ 0.5é€Ÿåº¦
            }
            
            get flowerPoints() {
                return Math.floor(this.score / 50) + 1; // ç¬¬ä¸€é˜¶æ®µ1åˆ†ï¼Œç¬¬äºŒé˜¶æ®µ2åˆ†ï¼Œä»¥æ­¤ç±»æ¨
            }
            
            updateBackground() {
                if (this.bloodMoonActive) {
                    document.body.style.background = 'linear-gradient(135deg, #2c0000, #4a0000, #6b0000)';
                    return;
                }
                
                const gradients = [
                    'linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)', // é»˜è®¤è“è‰²
                    'linear-gradient(135deg, #0c2461, #1e3799, #4a69bd)', // å¤œæ™š
                    'linear-gradient(135deg, #a9d8eb, #a0cf93, #f5e4a6)', // æ¸…æ™¨
                    'linear-gradient(135deg, #ff6b35, #f7931e, #ffd23f)' // æ—¥è½
                ];
                
                let index = Math.floor(this.score / 50) % gradients.length;
                document.body.style.background = gradients[index];
            }
            
            handleInput() {
                // æå‡ç©å®¶è¿åŠ¨é€Ÿåº¦
                const moveSpeed = (this.player.boosting ? this.currentSpeed * 2.5 : this.currentSpeed) * 1.2;
                
                if (this.keys['a'] && this.player.x > 0) {
                    this.player.x -= moveSpeed;
                }
                if (this.keys['d'] && this.player.x < this.canvas.width - this.player.width) {
                    this.player.x += moveSpeed;
                }
                if (this.keys['w'] && this.player.y > 0) {
                    this.player.y -= moveSpeed;
                }
                if (this.keys['s'] && this.player.y < this.canvas.height - this.player.height) {
                    this.player.y += moveSpeed;
                }
            }
            
            getEventName(eventType) {
                const names = {
                    'meteor': 'ğŸ”¥ é™¨çŸ³å è½ä¸­!',
                    'goblin': 'ğŸ‘¹ å“¥å¸ƒæ—å…¥ä¾µ!',
                    'lantern': 'ğŸ® ç¯ç¬¼å¤œ!',
                    'bloodmoon': 'ğŸŒ™ è¡€æœˆé™ä¸´!'
                };
                return names[eventType] || eventType;
            }
            
            showEventNotification(text) {
                const notification = document.getElementById('eventNotification');
                notification.textContent = text;
                notification.style.opacity = '1';
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                }, 2500);
            }
            
            activateEvent(eventType) {
                switch(eventType) {
                    case 'meteor':
                        this.spawnMeteor();
                        break;
                    case 'goblin':
                        this.spawnGoblinInvasion();
                        break;
                    case 'lantern':
                        this.spawnLanterns();
                        break;
                    case 'bloodmoon':
                        this.activateBloodMoon();
                        break;
                }
            }
            
            spawnMeteor() {
                const meteor = {
                    x: Math.random() * (this.canvas.width - 200),
                    y: -300,
                    size: 150, // åŠå¾„å˜ä¸ºåŸæ¥çš„4å€
                    maxSize: 320,
                    targetSize: 320,
                    growing: true,
                    fallSpeed: 8,
                    impactRadius: 500, // çˆ†ç‚¸åŠå¾„å˜ä¸ºåŸæ¥çš„4å€
                    landed: false
                };
                this.meteors.push(meteor);
            }
            
            spawnGoblinInvasion() {
                const formations = ['line', 'L', 'person', 'V'];
                const formation = formations[Math.floor(Math.random() * formations.length)];
                const goblinCount = 10 + (this.currentPhase * 5);
                
                for (let i = 0; i < goblinCount; i++) {
                    let x, y;
                    const startX = Math.random() * (this.canvas.width - 200) + 100;
                    const startY = -50;
                    
                    switch(formation) {
                        case 'line':
                            x = startX + (i * 60);
                            y = startY;
                            break;
                        case 'L':
                            if (i < 6) {
                                x = startX;
                                y = startY + (i * 60);
                            } else {
                                x = startX + ((i - 5) * 60);
                                y = startY + 300;
                            }
                            break;
                        case 'person':
                            if (i < 5) {
                                x = startX - 60 + (i * 30); // èº«ä½“
                                y = startY + 60;
                            } else {
                                x = startX - 90 + ((i - 4) * 45); // è…¿éƒ¨
                                y = startY + 120;
                            }
                            break;
                        case 'V':
                            x = startX + (i * 40) - 160;
                            y = startY + Math.abs(i - 4) * 40;
                            break;
                    }
                    
                    this.goblins.push({
                        x: x,
                        y: y,
                        width: 30,
                        height: 30,
                        speed: this.currentSpeed * 2.5 // é€Ÿåº¦æ¯”æ™®é€šéšœç¢ç‰©å¿«2.5å€
                    });
                }
            }
            
            spawnLanterns() {
                // åˆ†æ•£åœ¨å¤šä¸ªæ’ä¸Š
                for (let row = 0; row < 3; row++) {
                    for (let col = 0; col < 4; col++) {
                        if (Math.random() > 0.2) { // éšæœºå‡ºç°çº¦10ä¸ª
                            this.lanterns.push({
                                x: Math.random() * (this.canvas.width - 25),
                                y: -25 - (row * 100), // åˆ†æ•£åœ¨ä¸åŒæ’
                                width: 25,
                                height: 35,
                                speed: this.currentSpeed // å’Œæ™®é€šéšœç¢ç‰©ç›¸åŒé€Ÿåº¦
                            });
                        }
                    }
                }
            }
            
            activateBloodMoon() {
                this.bloodMoonActive = true;
                this.bloodMoonTimer = 360; // 6ç§’ (60fps * 6)
                this.bloodMoonStartTime = this.currentPhase; // è®°å½•å¼€å§‹é˜¶æ®µ
                this.flowers = []; // æ¸…é™¤æ‰€æœ‰èŠ±æœµ
                // åœ¨è¡€æœˆæœŸé—´é¢å¤–ç”Ÿæˆå¤§é‡é²¨é±¼
                this.spawnBloodMoonSharks();
            }
            
            spawnBloodMoonSharks() {
                // ç”Ÿæˆæ•°é‡çš„é²¨é±¼
                for (let i = 0; i < 30; i++) { // 5å€æ•°
                    setTimeout(() => {
                        if (this.bloodMoonActive) {
                            this.obstacles.push({
                                x: Math.random() * (this.canvas.width - 40),
                                y: -40,
                                width: 40,
                                height: 40,
                                type: 'shark',
                                chasing: false,
                                chaseRange: 120,
                                chaseSpeed: 0,
                                maxChaseSpeed: this.currentSpeed * 1.1
                            });
                        }
                    }, i * 200); // æ¯éš”0.2ç§’ç”Ÿæˆä¸€ä¸ª
                }
            }
            
            spawnObstacles(currentTime) {
                if (currentTime - this.lastObstacleTime > this.obstacleInterval) {
                    const types = ['shark', 'rock', 'bomb'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    this.obstacles.push({
                        x: Math.random() * (this.canvas.width - 40),
                        y: -40,
                        width: 40,
                        height: 40,
                        type: type,
                        chasing: false,
                        chaseRange: type === 'shark' ? 150 : 0,
                        chaseSpeed: 0,
                        maxChaseSpeed: this.currentSpeed * 1.1 // é™ä½åˆ°1.05å€
                    });
                    
                    this.lastObstacleTime = currentTime;
                }
            }
            
            spawnFlowers(currentTime) {
                if (this.bloodMoonActive) return; // è¡€æœˆæœŸé—´ä¸ç”ŸæˆèŠ±æœµ
                
                if (currentTime - this.lastFlowerTime > this.flowerInterval) {
                    this.flowers.push({
                        x: Math.random() * (this.canvas.width - 30),
                        y: -30,
                        width: 30,
                        height: 30
                    });
                    this.lastFlowerTime = currentTime;
                }
            }
            
            spawnButterflies(currentTime) {
                if (currentTime - this.lastButterflyTime > this.butterflyInterval) {
                    this.butterflies.push({
                        x: Math.random() * (this.canvas.width - 25),
                        y: -25,
                        width: 25,
                        height: 25
                    });
                    this.lastButterflyTime = currentTime;
                }
            }
            
            updateMeteors() {
                for (let i = this.meteors.length - 1; i >= 0; i--) {
                    const meteor = this.meteors[i];
                    
                    if (!meteor.landed) {
                        // å¢å¤§é™¨çŸ³é˜´å½±
                        if (meteor.size < meteor.targetSize) {
                            meteor.size += 1.5;
                        }
                        
                        // ä¸‹è½
                        meteor.y += meteor.fallSpeed;
                        
                        // æ’å‡»åœ°é¢
                        if (meteor.y > this.canvas.height - meteor.impactRadius) {
                            meteor.landed = true;
                            
                            // æ£€æŸ¥æ˜¯å¦æ’å‡»ç©å®¶
                            const distance = Math.sqrt(
                                Math.pow(meteor.x + meteor.size/2 - (this.player.x + this.player.width/2), 2) +
                                Math.pow(meteor.y + meteor.size/2 - (this.player.y + this.player.height/2), 2)
                            );
                            
                            if (distance < meteor.impactRadius && !this.player.invincible) {
                                this.lives = Math.max(0, this.lives - 3); // æ‰£é™¤ä¸‰æ¡å‘½
                                this.player.invincible = true;
                                this.player.invincibleTimer = 180;
                                this.createParticles(meteor.x, meteor.y, '#8B0000'); // æš—çº¢è‰²
                                this.updateUI();
                                
                                if (this.lives <= 0) {
                                    this.gameOver();
                                }
                            }
                            
                            // åˆ›å»ºæ’å‡»æ•ˆæœ
                            this.createParticles(meteor.x, meteor.y, '#8B0000'); // æš—çº¢è‰²
                        }
                    } else {
                        // æ’å‡»ååœç•™ä¸€ä¼šå„¿ç„¶åæ¶ˆå¤±
                        meteor.stayTime = (meteor.stayTime || 0) + 1;
                        if (meteor.stayTime > 120) {
                            this.meteors.splice(i, 1);
                        }
                    }
                }
            }
            
            updateGoblins() {
                for (let i = this.goblins.length - 1; i >= 0; i--) {
                    const goblin = this.goblins[i];
                    goblin.y += goblin.speed;
                    
                    if (goblin.y > this.canvas.height) {
                        this.goblins.splice(i, 1);
                    }
                }
            }
            
            updateLanterns() {
                for (let i = this.lanterns.length - 1; i >= 0; i--) {
                    const lantern = this.lanterns[i];
                    lantern.y += lantern.speed;
                    
                    if (lantern.y > this.canvas.height) {
                        this.lanterns.splice(i, 1);
                    }
                }
            }
            
            updateBloodMoon() {
                if (this.bloodMoonActive) {
                    this.bloodMoonTimer--;
                    // ç»“æŸæ¡ä»¶ï¼šæ—¶é—´åˆ°10ç§’ æˆ–è€… è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µ
                    if (this.bloodMoonTimer <= 0 || this.currentPhase !== this.bloodMoonStartTime) {
                        this.bloodMoonActive = false;
                        this.bloodMoonTimer = 0;
                    }
                }
            }
            
            updateObstacles() {
                for (let i = this.obstacles.length - 1; i >= 0; i--) {
                    const obstacle = this.obstacles[i];
                    
                    // é²¨é±¼è¿½å‡»é€»è¾‘
                    if (obstacle.type === 'shark') {
                        const distance = Math.sqrt(
                            Math.pow(obstacle.x - this.player.x, 2) + 
                            Math.pow(obstacle.y - this.player.y, 2)
                        );
                        
                        if (distance < obstacle.chaseRange) {
                            obstacle.chasing = true;
                            // ç¼“æ…¢åŠ é€Ÿåˆ°æœ€å¤§é€Ÿåº¦
                            if (obstacle.chaseSpeed < obstacle.maxChaseSpeed) {
                                obstacle.chaseSpeed += 0.05;
                            }
                            
                            // è¿½è¸ªç©å®¶
                            if (obstacle.x < this.player.x) {
                                obstacle.x += obstacle.chaseSpeed;
                            } else {
                                obstacle.x -= obstacle.chaseSpeed;
                            }
                            
                            if (obstacle.y < this.player.y) {
                                obstacle.y += obstacle.chaseSpeed;
                            } else {
                                obstacle.y -= obstacle.chaseSpeed;
                            }
                        } else {
                            obstacle.chasing = false;
                            obstacle.chaseSpeed = Math.max(0, obstacle.chaseSpeed - 0.03); // å‡é€Ÿ
                            obstacle.y += this.currentSpeed;
                        }
                    } else {
                        // å…¶ä»–éšœç¢ç‰©ç»Ÿä¸€ä½¿ç”¨å½“å‰é€Ÿåº¦
                        obstacle.y += this.currentSpeed;
                    }
                    
                    // ç§»é™¤è¶…å‡ºå±å¹•çš„éšœç¢ç‰©
                    if (obstacle.y > this.canvas.height) {
                        this.obstacles.splice(i, 1);
                    }
                }
            }
            
            updateFlowers() {
                if (this.bloodMoonActive) return;
                
                // æ‰€æœ‰èŠ±æœµä½¿ç”¨ç»Ÿä¸€é€Ÿåº¦
                for (let i = this.flowers.length - 1; i >= 0; i--) {
                    this.flowers[i].y += this.currentSpeed;
                    if (this.flowers[i].y > this.canvas.height) {
                        this.flowers.splice(i, 1);
                    }
                }
            }
            
            updateButterflies() {
                // æ‰€æœ‰è´è¶ä½¿ç”¨ç»Ÿä¸€é€Ÿåº¦
                for (let i = this.butterflies.length - 1; i >= 0; i--) {
                    this.butterflies[i].y += this.currentSpeed;
                    if (this.butterflies[i].y > this.canvas.height) {
                        this.butterflies.splice(i, 1);
                    }
                }
            }
            
            checkCollisions() {
                if (this.player.invincible) return;
                
                // æ£€æŸ¥ä¸éšœç¢ç‰©ç¢°æ’
                for (let i = this.obstacles.length - 1; i >= 0; i--) {
                    const obstacle = this.obstacles[i];
                    if (this.isColliding(this.player, obstacle)) {
                        let damage = 1;
                        let particleColor = '#8B0000'; // é»˜è®¤æš—çº¢è‰²
                        
                        // æ ¹æ®ä¸åŒç±»å‹é€ æˆä¸åŒä¼¤å®³
                        if (obstacle.type === 'bomb') {
                            damage = 2;
                        }
                        
                        this.lives = Math.max(0, this.lives - damage);
                        this.player.invincible = true;
                        this.player.invincibleTimer = 180; // 3ç§’æ— æ•Œ (60fps * 3)
                        
                        // æ·»åŠ ç¢°æ’ç²’å­æ•ˆæœï¼ˆæš—çº¢è‰²ï¼‰
                        this.createParticles(this.player.x + this.player.width/2, 
                                           this.player.y + this.player.height/2, 
                                           particleColor);
                        
                        this.obstacles.splice(i, 1);
                        this.updateUI();
                        
                        if (this.lives <= 0) {
                            this.gameOver();
                        }
                        return; // ä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªç¢°æ’
                    }
                }
                
                // æ£€æŸ¥ä¸èŠ±æœµç¢°æ’
                for (let i = this.flowers.length - 1; i >= 0; i--) {
                    if (this.isColliding(this.player, this.flowers[i])) {
                        this.score += this.flowerPoints;
                        this.updateSpeed(); // æ£€æŸ¥æ˜¯å¦éœ€è¦æå‡é€Ÿåº¦
                        this.createParticles(this.flowers[i].x + this.flowers[i].width/2, 
                                           this.flowers[i].y + this.flowers[i].height/2, 
                                           '#ff6b35');
                        this.flowers.splice(i, 1);
                        this.updateUI();
                    }
                }
                
                // æ£€æŸ¥ä¸è´è¶ç¢°æ’
                for (let i = this.butterflies.length - 1; i >= 0; i--) {
                    if (this.isColliding(this.player, this.butterflies[i])) {
                        this.player.boosting = true;
                        this.player.boostTimer = 180; // 3ç§’åŠ é€Ÿ
                        this.createParticles(this.butterflies[i].x + this.butterflies[i].width/2, 
                                           this.butterflies[i].y + this.butterflies[i].height/2, 
                                           '#4cd137'); // ç»¿è‰²
                        this.butterflies.splice(i, 1);
                        this.updateUI();
                    }
                }
                
                // æ£€æŸ¥ä¸ç¯ç¬¼ç¢°æ’
                for (let i = this.lanterns.length - 1; i >= 0; i--) {
                    if (this.isColliding(this.player, this.lanterns[i])) {
                        this.lives = Math.min(9, this.lives + 1); // æœ€å¤š9æ¡å‘½
                        this.createParticles(this.lanterns[i].x + this.lanterns[i].width/2, 
                                           this.lanterns[i].y + this.lanterns[i].height/2, 
                                           '#ff0000'); // é²œçº¢è‰²
                        this.lanterns.splice(i, 1);
                        this.updateUI();
                    }
                }
                
                // æ£€æŸ¥ä¸å“¥å¸ƒæ—ç¢°æ’
                for (let i = this.goblins.length - 1; i >= 0; i--) {
                    if (this.isColliding(this.player, this.goblins[i])) {
                        this.lives = Math.max(0, this.lives - 1);
                        this.player.invincible = true;
                        this.player.invincibleTimer = 180;
                        this.createParticles(this.goblins[i].x + this.goblins[i].width/2, 
                                           this.goblins[i].y + this.goblins[i].height/2, 
                                           '#8B0000'); // æš—çº¢è‰²
                        this.goblins.splice(i, 1);
                        this.updateUI();
                        
                        if (this.lives <= 0) {
                            this.gameOver();
                        }
                        return;
                    }
                }
            }
            
            isColliding(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            }
            
            createParticles(x, y, color) {
                for (let i = 0; i < 20; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 15,
                        vy: (Math.random() - 0.5) * 15,
                        life: 50,
                        maxLife: 50,
                        color: color,
                        size: Math.random() * 6 + 3
                    });
                }
            }
            
            updateParticles() {
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.life--;
                    
                    if (particle.life <= 0) {
                        this.particles.splice(i, 1);
                    }
                }
            }
            
            updateTimers() {
                // æ›´æ–°æ— æ•Œè®¡æ—¶å™¨
                if (this.player.invincible) {
                    this.player.invincibleTimer--;
                    if (this.player.invincibleTimer <= 0) {
                        this.player.invincible = false;
                    }
                }
                
                // æ›´æ–°åŠ é€Ÿè®¡æ—¶å™¨
                if (this.player.boosting) {
                    this.player.boostTimer--;
                    if (this.player.boostTimer <= 0) {
                        this.player.boosting = false;
                    }
                }
            }
            
            updateUI() {
                document.getElementById('score').textContent = `å¾—åˆ†: ${this.score}`;
                
                // æ›´æ–°ç”Ÿå‘½å€¼æ˜¾ç¤º
                const hearts = document.querySelectorAll('.heart');
                hearts.forEach((heart, index) => {
                    heart.textContent = index < this.lives ? 'â¤ï¸' : 'ğŸ¤';
                });
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                const statusElement = document.getElementById('status');
                if (this.player.invincible) {
                    statusElement.textContent = 'ğŸ’« æ— æ•ŒçŠ¶æ€';
                    statusElement.style.color = '#fbc531';
                } else {
                    // åªæ˜¾ç¤ºé˜¶æ®µä¿¡æ¯
                    const phase = Math.floor(this.score / 50) + 1;
                    statusElement.textContent = `é˜¶æ®µ ${phase}`;
                    statusElement.style.color = 'white';
                }
            }
            
            gameOver() {
                this.gameRunning = false;
                this.gameState = 'gameOver';
                
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('gameOver').style.display = 'block';
            }
            
            drawPlayer() {
                this.ctx.save();
                
                // æ— æ•ŒçŠ¶æ€é—ªçƒæ•ˆæœ
                if (this.player.invincible && Math.floor(Date.now() / 100) % 2) {
                    this.ctx.globalAlpha = 0.5;
                }
                
                // ç»˜åˆ¶é’è‰²è§å…‰æ•ˆæœ
                this.ctx.shadowColor = '#00ffff';
                this.ctx.shadowBlur = 20;
                
                // ç»˜åˆ¶å°çŒ«å†²æµªæ¿
                this.ctx.font = '45px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(this.emojis.board, this.player.x + this.player.width/2, this.player.y + this.player.height/2);
                
                this.ctx.restore();
            }
            
            drawObstacles() {
                this.obstacles.forEach(obstacle => {
                    this.ctx.save();
                    this.ctx.font = '35px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    
                    switch(obstacle.type) {
                        case 'shark':
                            this.ctx.fillText(this.emojis.shark, obstacle.x + obstacle.width/2, obstacle.y + obstacle.height/2);
                            break;
                        case 'rock':
                            this.ctx.font = '30px Arial';
                            this.ctx.fillText(this.emojis.rock, obstacle.x + obstacle.width/2, obstacle.y + obstacle.height/2);
                            break;
                        case 'bomb':
                            this.ctx.fillText(this.emojis.bomb, obstacle.x + obstacle.width/2, obstacle.y + obstacle.height/2);
                            break;
                    }
                    
                    this.ctx.restore();
                });
            }
            
            drawFlowers() {
                if (this.bloodMoonActive) return;
                
                this.flowers.forEach(flower => {
                    this.ctx.save();
                    this.ctx.font = '25px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(this.emojis.flower, flower.x + flower.width/2, flower.y + flower.height/2);
                    this.ctx.restore();
                });
            }
            
            drawButterflies() {
                this.butterflies.forEach(butterfly => {
                    this.ctx.save();
                    this.ctx.font = '25px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(this.emojis.butterfly, butterfly.x + butterfly.width/2, butterfly.y + butterfly.height/2);
                    this.ctx.restore();
                });
            }
            
            drawMeteors() {
                this.meteors.forEach(meteor => {
                    this.ctx.save();
                    this.ctx.globalAlpha = meteor.landed ? 0.7 : 0.9;
                    
                    if (!meteor.landed) {
                        // ç»˜åˆ¶é™¨çŸ³é˜´å½±ï¼ˆé€æ¸å¢å¤§ï¼Œå°ºå¯¸å˜ä¸º4å€ï¼‰
                        this.ctx.font = `${meteor.size}px Arial`;
                        this.ctx.textAlign = 'center';
                        this.ctx.textBaseline = 'middle';
                        this.ctx.fillText(this.emojis.meteorShadow, meteor.x + meteor.size/2, meteor.y + meteor.size/2);
                    } else {
                        // ç»˜åˆ¶è½åœ°çš„é™¨çŸ³å‘ï¼ˆåŠå¾„æ‰©å¤§4å€ï¼‰
                        this.ctx.fillStyle = 'rgba(105, 105, 105, 0.7)';
                        this.ctx.beginPath();
                        this.ctx.arc(meteor.x + meteor.size/2, this.canvas.height - 20, meteor.impactRadius, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        // é™¨çŸ³æœ¬èº«ï¼ˆå°ºå¯¸å˜ä¸º4å€ï¼‰
                        this.ctx.font = '160px Arial';
                        this.ctx.fillText(this.emojis.meteor, meteor.x + meteor.size/2, this.canvas.height - 20);
                    }
                    
                    this.ctx.restore();
                });
            }
            
            drawGoblins() {
                this.goblins.forEach(goblin => {
                    this.ctx.save();
                    this.ctx.font = '30px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(this.emojis.goblin, goblin.x + goblin.width/2, goblin.y + goblin.height/2);
                    this.ctx.restore();
                });
            }
            
            drawLanterns() {
                this.lanterns.forEach(lantern => {
                    this.ctx.save();
                    this.ctx.font = '30px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(this.emojis.lantern, lantern.x + lantern.width/2, lantern.y + lantern.height/2);
                    this.ctx.restore();
                });
            }
            
            drawParticles() {
                this.particles.forEach(particle => {
                    this.ctx.save();
                    this.ctx.globalAlpha = particle.life / particle.maxLife;
                    this.ctx.fillStyle = particle.color;
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.restore();
                });
            }
            
            drawWaterEffects() {
                // ç»˜åˆ¶æµ·æ°´
                const time = Date.now() * 0.003;
                
                // æ¸å˜èƒŒæ™¯è‰²å åŠ ä»¥å¢å¼ºæµ·æ´‹æ•ˆæœ
                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                gradient.addColorStop(0, 'rgba(30, 144, 255, 0.3)');
                gradient.addColorStop(1, 'rgba(0, 191, 255, 0.1)');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // æ³¢æµªçº¿æ¡
                this.ctx.strokeStyle = 'rgba(30, 144, 255, 0.7)';
                this.ctx.lineWidth = 2;
                
                // ç»˜åˆ¶å¤šå±‚æ³¢æµª
                for (let layer = 0; layer < 3; layer++) {
                    this.ctx.beginPath();
                    const yOffset = layer * 15;
                    const amplitude = 8 - layer * 2;
                    const frequency = 0.02 + layer * 0.01;
                    const speed = 0.5 + layer * 0.2;
                    
                    for (let x = 0; x <= this.canvas.width; x += 5) {
                        const y = this.canvas.height - 60 + yOffset + Math.sin(x * frequency + time * speed) * amplitude;
                        if (x === 0) {
                            this.ctx.moveTo(x, y);
                        } else {
                            this.ctx.lineTo(x, y);
                        }
                    }
                    this.ctx.stroke();
                }
            }
            
            gameLoop() {
                if (this.gameState === 'playing' && this.gameRunning) {
                    const currentTime = Date.now();
                    
                    // æ¸…ç©ºç”»å¸ƒ
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // æ›´æ–°æ¸¸æˆé€»è¾‘
                    this.handleInput();
                    this.checkPhaseEvents(); // æ£€æŸ¥é˜¶æ®µäº‹ä»¶è§¦å‘
                    this.spawnObstacles(currentTime);
                    this.spawnFlowers(currentTime);
                    this.spawnButterflies(currentTime);
                    this.updateMeteors();
                    this.updateGoblins();
                    this.updateLanterns();
                    this.updateBloodMoon();
                    this.updateObstacles();
                    this.updateFlowers();
                    this.updateButterflies();
                    this.checkCollisions();
                    this.updateParticles();
                    this.updateTimers();
                    this.updateBackground();
                    
                    // ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
                    this.drawWaterEffects();
                    this.drawObstacles();
                    this.drawFlowers();
                    this.drawButterflies();
                    this.drawMeteors();
                    this.drawGoblins();
                    this.drawLanterns();
                    this.drawParticles();
                    this.drawPlayer();
                    
                    // æ›´æ–°UI
                    this.updateUI();
                }
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        // å¯åŠ¨æ¸¸æˆ
        window.addEventListener('load', () => {
            window.game = new SurfingGame();
        });
    </script>
</body>
</html>
